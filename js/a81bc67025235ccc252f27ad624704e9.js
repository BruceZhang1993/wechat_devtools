'use strict';!function(require,directRequire){function a(){let a=h.getCurrent(),b='tourist'==a.appid,c=a.setting.urlCheck,d=!0;return b?d=!1:!c&&(d=!1),d}var b=Math.floor;const c=require('fs'),d=require('path'),e=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),f=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),g=require('./233d77ecf0781f44985f684f70e316d0.js'),h=require('./3bfffbe88b3d923921f851c0697974fe.js'),i=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js'),j=require('./a1dd553cc059d528bb0ef56afed53968.js'),k=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),l=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),m={"text/plain":'txt',"application/vnd.android.package-archive":'apk',"video/3gpp":'3gp',"application/atom+xml":'atom',"video/x-msvideo":'avi',"application/x-bcpio":'bcpio',"image/bmp":'bmp',"image/cgm":'cgm',"application/x-cpio":'cpio',"application/mac-compactpro":'cpt',"application/x-csh":'csh',"text/css":'css',"application/xml-dtd":'dtd',"application/x-dvi":'dvi',"application/x-director":'dxr',"application/postscript":'eps',"text/x-setext":'etx',"application/andrew-inset":'ez',"video/x-flv":'flv',"image/gif":'gif',"application/srgs":'gram',"application/srgs+xml":'grxml',"application/x-gtar":'gtar',"application/x-gzip":'gz',"application/x-hdf":'hdf',"application/mac-binhex40":'hqx',"x-conference/x-cooltalk":'ice',"image/x-icon":'ico',"image/ief":'ief',"application/x-java-jnlp-file":'jnlp',"image/jp2":'jp2',"application/x-javascript":'js',"application/x-latex":'latex',"audio/x-mpegurl":'m3u',"video/x-m4v":'m4v',"application/x-troff-man":'man',"application/mathml+xml":'mathml',"application/x-troff-me":'me',"application/vnd.mif":'mif',"video/x-sgi-movie":'movie',"video/mp4":'mp4',"application/x-troff-ms":'ms',"application/oda":'oda',"application/ogg":'ogg',"video/ogv":'ogv',"image/x-portable-bitmap":'pbm',"chemical/x-pdb":'pdb',"application/pdf":'pdf',"image/x-portable-graymap":'pgm',"application/x-chess-pgn":'pgn',"image/png":'png',"image/x-portable-anymap":'pnm',"image/x-portable-pixmap":'ppm',"image/x-cmu-raster":'ras',"application/rdf+xml":'rdf',"image/x-rgb":'rgb',"application/vnd.rn-realmedia":'rm',"text/rtf":'rtf',"text/richtext":'rtx',"application/x-sh":'sh',"application/x-shar":'shar',"application/x-stuffit":'sit',"application/x-futuresplash":'spl',"application/x-wais-source":'src',"application/x-sv4cpio":'sv4cpio',"application/x-sv4crc":'sv4crc',"image/svg+xml":'svg',"application/x-shockwave-flash":'swf',"application/x-tar":'tar',"application/x-tcl":'tcl',"application/x-tex":'tex',"text/tab-separated-values":'tsv',"application/x-ustar":'ustar',"application/x-cdlink":'vcd',"application/voicexml+xml":'vxml',"audio/x-wav":'wav',"image/vnd.wap.wbmp":'wbmp',"application/vnd.wap.wbxml":'wbxml',"video/webm":'webm',"text/vnd.wap.wml":'wml',"application/vnd.wap.wmlc":'wmlc',"text/vnd.wap.wmlscript":'wmls',"application/vnd.wap.wmlscriptc":'wmlsc',"video/x-ms-wmv":'wmv',"image/x-xbitmap":'xbm',"image/x-xpixmap":'xpm',"application/xslt+xml":'xslt',"application/vnd.mozilla.xul+xml":'xul',"image/x-xwindowdump":'xwd',"chemical/x-xyz":'xyz',"application/zip":'zip'},n=/^(http|ws)s?:\/\/[\w-.]+(:\d+)?/i;let o=0,p=0,q={},r=1,s={},t=1;module.exports={downloadFile:async function(b,f){let j=f.args;if(i.isLocalId(j.url)){let a=i.getFileRealPath(j.url);return a&&c.existsSync(a.fileRealPath)?{errMsg:`${f.api}:ok`,statusCode:200,tempFilePath:j.url}:{errMsg:`${f.api}:ok`,statusCode:404}}const o=e.getState();let q=h.getCurrent();const r=o.toolbar.network.list[o.toolbar.network.current];if('none'==r)return{errMsg:`${f.api}:fail network is down`};const s=h.getCurrentConfig(),t=1024*(1024*s.setting.DownloadFileSizeLimit),u=o.simulator.appConfig||{},v=s.setting.MaxDownloadConcurrent;return p>=v?{errMsg:`${f.api}:fail exceed max download connection count ${v}`}:new Promise((b)=>{let e=!1;const o=(a)=>{e||(p--,b(a),e=!0)};try{p++;let b=0,e=200,r=d.extname(j.url.split('?')[0]),s=i.createTmpfileName(q,r),v=i.getFileRealPath(s),w=v.fileRealPath,x=j.header&&'object'==typeof j.header?j.header:{};x.Referer=`https://servicewechat.com/${h.getProjectAppID()}/devtools/page-frame.html`;let y=!1,z={method:'get',url:j.url,encoding:null,headers:x,timeout:u.networkTimeout&&u.networkTimeout.downloadFile||6e4,followRedirect:function(b){if(!a())return!0;let c=b.statusCode;if(300<=c&&400>c&&(302==c||301==c)){let a=b.caseless.get('location'),c=h.getCurrentDomains().download,d=n.exec(a.toLowerCase());d=d&&d[0]||'';for(let a=0;a<c.length;a++){let b=c[a],e=n.exec(b.toLowerCase());if(e=e&&e[0],e==d)return!0}let e=[];c.forEach((a)=>{e.push([a])}),k.display({command:l.DISPLAY_INFO,type:l.DISPLAY_TYPES.DOMAIN_ERROR,data:{type:'download',url:`302: ${a}`,domains:e}}),y=!0}return!1}};a()?z.agentOptions={secureProtocol:'TLSv1_2_method'}:z.tunnel=!1;let A=g(z),B=[];A.on('response',(a)=>{if(e=a.statusCode,200!=e&&206!=e)y?o({errMsg:`${f.api}:fail url not in domain list`}):o({errMsg:`${f.api}:ok`,statusCode:e});else{let b=parseInt(a.headers['content-length']);if(a.headers['content-type']){const b=a.headers['content-type'].replace(/;.*/g,''),c=m[b.toLowerCase()];if(c)r=`.${c}`;else{let a=b.split('/');a&&a[1]&&!/\-|\+/ig.test(a[1])&&(r=`.${a[1]}`)}}b>t&&(A.abort(),o({errMsg:`${f.api}:fail exceed max file size`}))}}).on('error',function(a){a&&'EPROTO'===a.code?o({errMsg:`${f.api}:fail 小程序要求的 TLS 版本必须大于等于 1.2`}):a&&'ETIMEDOUT'===a.code?o({errMsg:`${f.api}:fail timeout`}):o({errMsg:`${f.api}:fail ${a}`})}).on('data',(a)=>{b+=a.length,B.push(a),b>t&&(A.abort(),o({errMsg:`${f.api}:fail exceed max file size`}))}).on('end',()=>{let a=Buffer.concat(B),b=i.initTmpfileName(q,a,r),d=i.getFileRealPath(b),g=d.fileRealPath;c.writeFileSync(g,a),c.unlink(w,()=>{}),o({errMsg:`${f.api}:ok`,tempFilePath:b,statusCode:e})}).pipe(c.createWriteStream(w))}catch(a){o({errMsg:`${f.api}:fail ${a}`})}})},uploadFile:async function(b,d){let f=d.args;const j=h.getCurrentConfig(),k=j.setting.MaxUploadConcurrent,l=e.getState(),m=l.toolbar.network.list[l.toolbar.network.current];if('none'==m)return{errMsg:`${d.api}:fail network is down`};if(o>=k)return{errMsg:`${d.api}:fail exceed max upload connection count ${k}`};let n=f.filePath,p=i.getFileRealPath(n),q=p.fileRealPath;if(!c.existsSync(q))return{errMsg:`${d.api}:fail file not found`};const r=l.simulator.appConfig||{};return new Promise((b)=>{let e=!1;const i=(a)=>{e||(o--,e=!0,b(a))};try{o++;let b={url:f.url,headers:f.header||{},formData:f.formData||{},method:'post',timeout:r.networkTimeout&&r.networkTimeout.uploadFile||6e4};a()?b.agentOptions={secureProtocol:'TLSv1_2_method'}:b.tunnel=!1,b.formData[f.name]=c.createReadStream(q),b.headers.Referer=`https://servicewechat.com/${h.getProjectAppID()}/devtools/page-frame.html`;g(b,(a,b,c)=>{let e={};e=a?b&&b.statusCode?{errMsg:`${d.api}:ok`,statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{errMsg:`${d.api}:fail 小程序要求的 TLS 版本必须大于等于 1.2`}:'ETIMEDOUT'===a.code?{errMsg:`${d.api}:fail timeout`}:{errMsg:`${d.api}:fail ${a}`}:{errMsg:`${d.api}:ok`,statusCode:b.statusCode,data:c},i(e)})}catch(a){i({errMsg:`${d.api}:fail ${a}`})}})},createUploadTask:async function(d,f){let k=f.args,l=h.getCurrentConfig();const m=l.setting.MaxUploadConcurrent,n=e.getState(),p=n.toolbar.network.list[n.toolbar.network.current];if('none'==p)return{errMsg:`${f.api}:fail network is down`};if(o>=m)return{errMsg:`${f.api}:fail exceed max upload connection count ${m}`};let s=k.filePath,t=i.getFileRealPath(s),u=t.fileRealPath;if(!c.existsSync(u))return{errMsg:`${f.api}:fail file not found`};const v=n.simulator.appConfig||{};try{o++;let d={url:k.url,headers:k.header||{},formData:k.formData||{},method:'post',timeout:v.networkTimeout&&v.networkTimeout.uploadFile||6e4};d.headers.Referer=`https://servicewechat.com/${h.getProjectAppID()}/devtools/page-frame.html`,a()&&(d.agentOptions={secureProtocol:'TLSv1_2_method'});let e=c.createReadStream(u);d.formData[k.name]=e;let i=r++,l=c.statSync(u),m=0;e.on('data',function(a){m+=a.length,j.triggerOnEvent({eventName:'onUploadTaskStateChange',data:{uploadTaskId:i,state:'progressUpdate',progress:b(100*(m/l.size)),totalBytesSent:m,totalBytesExpectedToSend:l.size}})});const n=(a)=>{q[i]&&(j.triggerOnEvent({eventName:'onUploadTaskStateChange',data:Object.assign({uploadTaskId:i},a)}),o--,delete q[i])};let p=g(d,(a,b,c)=>{let d={};d=a?b&&b.statusCode?{state:'success',statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{state:'fail',errMsg:'\u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}:'ETIMEDOUT'===a.code?{statSync:'fail',errMsg:'timeout'}:{state:'fail',errMsg:`${a}`}:{state:'success',statusCode:b.statusCode,data:c},n(d)});return p.on('abort',()=>{setTimeout(()=>{n({state:'fail',errMsg:'abort'})},0)}),q[i]={id:i,request:p},{errMsg:`${f.api}:ok`,uploadTaskId:i}}catch(a){return o--,{errMsg:`${f.api}:fail ${a}'`}}},operateUploadTask:async function(a,b){let c=b.args,d=c.uploadTaskId,e=c.operationType,f=q[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},createDownloadTask:async function(o,q){let r=q.args;const u=e.getState(),v=u.toolbar.network.list[u.toolbar.network.current];let w=h.getCurrent();if('none'==v)return{errMsg:`${q.api}:fail network is down`};if(r.url&&!/^https?:\/\//.test(r.url.toLowerCase()))return{errMsg:`${q.api}:fail invalid url`};const x=h.getCurrentConfig(),y=x.setting.MaxDownloadConcurrent;if(p>=y)return{errMsg:`${q.api}:fail exceed max download connection count ${y}`};const z=1024*(1024*x.setting.DownloadFileSizeLimit);let A=r.header&&'object'==typeof r.header?r.header:{};A.Referer=`https://servicewechat.com/${h.getProjectAppID()}/devtools/page-frame.html`;try{p++;let e=0,v=[],x=200,y=d.extname(r.url.split('?')[0]),B=i.createTmpfileName(w,y),C=i.getFileRealPath(B),D=C.fileRealPath,E=u.simulator.appConfig||{},F=!1,G={method:'get',url:r.url,encoding:null,headers:A,timeout:E.networkTimeout&&E.networkTimeout.downloadFile||6e4,followRedirect:function(b){if(!a())return!0;let c=b.statusCode;if(300<=c&&400>c&&(302==c||301==c)){let a=h.getCurrentDomains().download,c=b.caseless.get('location'),d=n.exec(c.toLowerCase());d=d&&d[0]||'';for(let b=0;b<a.length;b++){let c=a[b],e=n.exec(c.toLowerCase());if(e=e&&e[0],e==d)return!0}let e=[];a.forEach((a)=>{e.push([a])}),k.display({command:l.DISPLAY_INFO,type:l.DISPLAY_TYPES.DOMAIN_ERROR,data:{type:'download',url:`302: ${c}`,domains:e}}),F=!0}return!1}};a()?G.agentOptions={secureProtocol:'TLSv1_2_method'}:G.tunnel=!1;let H=t++;o({type:f.ASSDK_CALLBACK,res:{errMsg:`${q.api}:ok`,downloadTaskId:H},callbackID:q.callbackID});let I=g(G);s[H]={downloadTaskId:H,request:I};let J=z;const K=(a)=>{s[H]&&(delete s[H],p--,j.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:Object.assign({downloadTaskId:H},a)}))},L=(a,c)=>{j.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:{downloadTaskId:H,state:'progressUpdate',totalBytesWritten:a,totalBytesExpectedToWrite:c,progress:b(100*(a/c))}})};if(i.isLocalId(r.url)){let a=i.getFileRealPath(r.url);if(!(a&&c.existsSync(a.fileRealPath)))K({state:'success',statusCode:404});else if(r.filePath){let a=i.copyFile(w,r.url,r.filePath);a.error?K({state:'fail',statusCode:403,errMsg:`permission denied, open "${r.filePath}"`}):K({state:'success',filePath:r.filePath,statusCode:200})}else K({state:'success',tempFilePath:r.url,statusCode:200});return}I.on('response',(a)=>{if(x=a.statusCode,200!=x&&206!=x)F?K({state:'fail',errMsg:'url not in domain list'}):K({state:'success',statusCode:x});else{let b=parseInt(a.headers['content-length']);if(b>z?(I.abort(),K({state:'fail',errMsg:'exceed max file size'})):J=b,a.headers['content-type']){const b=a.headers['content-type'].replace(/;.*/g,''),c=m[b.toLowerCase()];if(c)y=`.${c}`;else{let a=b.split('/');a&&a[1]&&!/\-|\+/ig.test(a[1])&&(y=`.${a[1]}`)}}}}).on('error',function(a){a&&'EPROTO'===a.code?K({state:fail,errMsg:'\u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}):a&&'ETIMEDOUT'===a.code?K({state:'fail',errMsg:`timeout`}):K({state:'fail',errMsg:`${a}`})}).on('data',(a)=>{e+=a.length,v.push(a),e>z?(K({state:'fail',errMsg:'exceed max file size'}),I.abort()):L(e,J)}).on('abort',()=>{setTimeout(()=>{K({state:'fail',errMsg:'abort'})},0)}).on('end',()=>{let a=Buffer.concat(v),b=i.initTmpfileName(w,a,y),d=i.getFileRealPath(b),e=d.fileRealPath;if(c.writeFileSync(e,a),c.unlink(D,()=>{}),r.filePath){const a=i.rename(w,b,r.filePath);a.error?(K({state:'fail',errMsg:`permission denied, open "${r.filePath}"`,statusCode:x}),c.unlink(b,()=>{}),c.unlink(D,()=>{}),c.unlink(e,()=>{})):K({state:'success',filePath:r.filePath,statusCode:x})}else K({state:'success',tempFilePath:b,statusCode:x})}).pipe(c.createWriteStream(D))}catch(a){return{errMsg:`${q.api}:fail ${a}`}}},operateDownloadTask:async function(a,b){let c=b.args,d=c.downloadTaskId,e=c.operationType,f=s[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},resetNetworkStatus:function(){for(var a in q)try{q[a].request.abort()}catch(a){}for(var a in s)try{s[a].request.abort()}catch(a){}o=0,p=0,q={},s={}}}}(require('lazyload'),require);