'use strict';!function(require,directRequire){function a(){let a=g.getCurrent(),b='tourist'==a.appid,c=a.setting.urlCheck,d=!0;return b?d=!1:!c&&(d=!1),d}const b=require('fs'),c=require('path'),d=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),e=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),f=require('./233d77ecf0781f44985f684f70e316d0.js'),g=require('./3bfffbe88b3d923921f851c0697974fe.js'),h=require('./c6f15ef7a40988103528a2ff766b2425.js'),i=require('./a1dd553cc059d528bb0ef56afed53968.js');let j=0,k=0,l={},m=1,n={},o=1;module.exports={downloadFile:async function(e,i){let j=i.args;const l=d.getState(),m=l.toolbar.network.list[l.toolbar.network.current];if('none'==m)return{errMsg:`${i.api}:fail network is down`};const n=g.getCurrentConfig(),o=1024*(1024*n.setting.DownloadFileSizeLimit),p=l.simulator.appConfig||{},q=n.setting.MaxDownloadConcurrent;return k>=q?{errMsg:`${i.api}:fail exceed max download connection count ${q}`}:new Promise((d)=>{let e=!1;const l=(a)=>{e||(k--,d(a),e=!0)};try{k++;let d=0,e=200,m=h.createNewLocalId()+c.extname(j.url.split('?')[0]),n=h.getRealPath(m),q=j.header||{};q.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;let r={method:'get',url:j.url,encoding:null,headers:q,timeout:p.networkTimeout&&p.networkTimeout.downloadFile||6e4,followRedirect:function(a){let b=!1;(project.urlCheck||project.isTourist)&&(b=!0);let c=a.statusCode;if(300<=c&&400>c&&(302==c||301==c)){let c=a.caseless.get('location'),d=g.getCurrentDomains().download;for(let a=0;a<d.length;a++)if(c&&0===c.indexOf(d[a])){b=!0;break}}return b}};a()?r.agentOptions={secureProtocol:'TLSv1_2_method'}:r.tunnel=!1;let s=f(r);s.on('response',(a)=>{if(e=a.statusCode,200!=e&&206!=e)l({errMsg:`${i.api}:ok`,statusCode:e});else{let b=parseInt(a.headers['content-length']);b>o&&(s.abort(),l({errMsg:`${i.api}:fail exceed max file size`}))}}).on('error',function(a){a&&'EPROTO'===a.code?l({errMsg:`${i.api}:fail 小程序要求的 TLS 版本必须大于等于 1.2`}):a&&'ETIMEDOUT'===a.code?l({errMsg:`${i.api}:fail timeout`}):l({errMsg:`${i.api}:fail ${a}`})}).on('data',(a)=>{d+=a.length,d>o&&(s.abort(),l({errMsg:`${i.api}:fail exceed max file size`}))}).on('end',()=>{l({errMsg:`${i.api}:ok`,tempFilePath:m,statusCode:e})}).pipe(b.createWriteStream(n))}catch(a){l({errMsg:`${i.api}:fail ${a}`})}})},uploadFile:async function(c,i){let e=i.args;const k=g.getCurrentConfig(),l=k.setting.MaxUploadConcurrent,m=d.getState(),n=m.toolbar.network.list[m.toolbar.network.current];if('none'==n)return{errMsg:`${i.api}:fail network is down`};if(j>=l)return{errMsg:`${i.api}:fail exceed max upload connection count ${l}`};let o=e.filePath,p=h.getRealPath(o);if(!b.existsSync(p))return{errMsg:`${i.api}:fail file not found`};const q=m.simulator.appConfig||{};return new Promise((c)=>{let d=!1;const h=(a)=>{d||(j--,d=!0,c(a))};try{j++;let c={url:e.url,headers:e.header||{},formData:e.formData||{},method:'post',timeout:q.networkTimeout&&q.networkTimeout.uploadFile||6e4};a()?c.agentOptions={secureProtocol:'TLSv1_2_method'}:c.tunnel=!1,c.formData[e.name]=b.createReadStream(p),c.headers.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;f(c,(a,b,c)=>{let d={};d=a?b&&b.statusCode?{errMsg:`${i.api}:ok`,statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{errMsg:`${i.api}:fail 小程序要求的 TLS 版本必须大于等于 1.2`}:'ETIMEDOUT'===a.code?{errMsg:`${i.api}:fail timeout`}:{errMsg:`${i.api}:fail ${a}`}:{errMsg:`${i.api}:ok`,statusCode:b.statusCode,data:c},h(d)})}catch(a){h({errMsg:`${i.api}:fail ${a}`})}})},createUploadTask:async function(c,k){let e=k.args,n=g.getCurrentConfig();const o=n.setting.MaxUploadConcurrent,p=d.getState(),q=p.toolbar.network.list[p.toolbar.network.current];if('none'==q)return{errMsg:`${k.api}:fail network is down`};if(j>=o)return{errMsg:`${k.api}:fail exceed max upload connection count ${o}`};let r=e.filePath,s=h.getRealPath(r);if(!b.existsSync(s))return{errMsg:`${k.api}:fail file not found`};const t=p.simulator.appConfig||{};try{j++;let c={url:e.url,headers:e.header||{},formData:e.formData||{},method:'post',timeout:t.networkTimeout&&t.networkTimeout.uploadFile||6e4};c.headers.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`,a()&&(c.agentOptions={secureProtocol:'TLSv1_2_method'});let d=b.createReadStream(s);c.formData[e.name]=d;let h=m++,n=b.statSync(s),o=0;d.on('data',function(a){o+=a.length,i.triggerOnEvent({eventName:'onUploadTaskStateChange',data:{uploadTaskId:h,state:'progressUpdate',progress:Math.floor(100*(o/n.size)),totalBytesSent:o,totalBytesExpectedToSend:n.size}})});const p=(a)=>{l[h]&&(i.triggerOnEvent({eventName:'onUploadTaskStateChange',data:Object.assign({uploadTaskId:h},a)}),j--,delete l[h])};let q=f(c,(a,b,c)=>{let d={};d=a?b&&b.statusCode?{state:'success',statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{state:'fail',errMsg:'\u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}:'ETIMEDOUT'===a.code?{statSync:'fail',errMsg:'timeout'}:{state:'fail',errMsg:`${a}`}:{state:'success',statusCode:b.statusCode,data:c},p(d)});return q.on('abort',()=>{setTimeout(()=>{p({state:'fail',errMsg:'abort'})},0)}),l[h]={id:h,request:q},{errMsg:`${k.api}:ok`,uploadTaskId:h}}catch(a){return j--,{errMsg:`${k.api}:fail ${a}'`}}},operateUploadTask:async function(a,b){let c=b.args,d=c.uploadTaskId,e=c.operationType,f=l[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},createDownloadTask:async function(j,l){let m=l.args;const p=d.getState(),q=p.toolbar.network.list[p.toolbar.network.current];if('none'==q)return{errMsg:`${l.api}:fail network is down`};const r=g.getCurrentConfig(),s=r.setting.MaxDownloadConcurrent;if(k>=s)return{errMsg:`${l.api}:fail exceed max download connection count ${s}`};const t=1024*(1024*r.setting.DownloadFileSizeLimit);let u=m.header||{};u.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;try{k++;let d=0,q=200,r=h.createNewLocalId()+c.extname(m.url.split('?')[0]),s=h.getRealPath(r),v=p.simulator.appConfig||{},w={method:'get',url:m.url,encoding:null,headers:u,timeout:v.networkTimeout&&v.networkTimeout.downloadFile||6e4,followRedirect:function(a){let b=!1;(project.urlCheck||project.isTourist)&&(b=!0);let c=a.statusCode;if(300<=c&&400>c&&(302==c||301==c)){let c=a.caseless.get('location'),d=g.getCurrentDomains().download;for(let a=0;a<d.length;a++)if(c&&0===c.indexOf(d[a])){b=!0;break}}return b}};a()?w.agentOptions={secureProtocol:'TLSv1_2_method'}:w.tunnel=!1;let x=o++;j({type:e.ASSDK_CALLBACK,res:{errMsg:`${l.api}:ok`,downloadTaskId:x},callbackID:l.callbackID});let y=f(w);n[x]={downloadTaskId:x,request:y};let z=t;const A=(a)=>{n[x]&&(delete n[x],k--,i.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:Object.assign({downloadTaskId:x},a)}))},B=(a)=>{i.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:{downloadTaskId:x,state:'progressUpdate',progress:a}})};y.on('response',(a)=>{if(q=a.statusCode,200!=q&&206!=q)A({state:'success',statusCode:q});else{let b=parseInt(a.headers['content-length']);b>t?(y.abort(),A({state:'fail',errMsg:'downloadFile:fail exceed max file size'})):z=b}}).on('error',function(a){a&&'EPROTO'===a.code?A({state:fail,errMsg:'\u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}):a&&'ETIMEDOUT'===a.code?A({state:'fail',errMsg:`timeout`}):A({state:'fail',errMsg:`${a}`})}).on('data',(a)=>{d+=a.length,d>t?(A({state:'fail',errMsg:'exceed max file size'}),y.abort()):B(d/z)}).on('abort',()=>{setTimeout(()=>{A({state:'fail',errMsg:'abort'})},0)}).on('end',()=>{A({state:'success',tempFilePath:r,statusCode:q})}).pipe(b.createWriteStream(s))}catch(a){return{errMsg:`${l.api}:fail ${a}`}}},operateDownloadTask:async function(a,b){let c=b.args,d=c.downloadTaskId,e=c.operationType,f=n[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}}}}(require('lazyload'),require);