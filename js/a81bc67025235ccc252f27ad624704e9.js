'use strict';!function(require,directRequire){function a(){let a=g.getCurrent(),b='tourist'==a.appid,c=a.setting.urlCheck,d=!0;return b?d=!1:!c&&(d=!1),d}const b=require('fs'),c=require('path'),d=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),e=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),f=require('./233d77ecf0781f44985f684f70e316d0.js'),g=require('./3bfffbe88b3d923921f851c0697974fe.js'),h=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js'),i=require('./a1dd553cc059d528bb0ef56afed53968.js'),j=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),k=require('./56c390e04c10e91a4aa2a2c19d9a885d.js');let l=0,m=0,n={},o=1,p={},q=1;module.exports={downloadFile:async function(e,i){let l=i.args;const n=d.getState(),o=n.toolbar.network.list[n.toolbar.network.current];let p=g.getCurrent();if('none'==o)return{errMsg:`${i.api}:fail network is down`};const q=g.getCurrentConfig(),r=1024*(1024*q.setting.DownloadFileSizeLimit),s=n.simulator.appConfig||{},t=q.setting.MaxDownloadConcurrent;return m>=t?{errMsg:`${i.api}:fail exceed max download connection count ${t}`}:new Promise((d)=>{let e=!1;const n=(a)=>{e||(m--,d(a),e=!0)};try{m++;let d=0,e=200,o=c.extname(l.url.split('?')[0]),q=h.createTmpfileName(p,o),t=h.getFileRealPath(q),u=t.fileRealPath,v=l.header&&'object'==typeof l.header?l.header:{};v.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;let w=!1,x={method:'get',url:l.url,encoding:null,headers:v,timeout:s.networkTimeout&&s.networkTimeout.downloadFile||6e4,followRedirect:function(b){if(!a())return!0;let c=b.statusCode;if(300<=c&&400>c&&(302==c||301==c)){let a=b.caseless.get('location'),c=g.getCurrentDomains().download;a=a.split('?')[0]||'';for(let b,d=0;d<c.length;d++){if(b=c[d],b&&0===b.indexOf(a))return!0;if(/\/$/.test(b)||(b+='/'),0===a.indexOf(b))return!0}let d=[];c.forEach((a)=>{d.push([a])}),j.display({command:k.DISPLAY_INFO,type:k.DISPLAY_TYPES.DOMAIN_ERROR,data:{type:'download',url:`302: ${a}`,domains:d}}),w=!0}return!1}};a()?x.agentOptions={secureProtocol:'TLSv1_2_method'}:x.tunnel=!1;let y=f(x),z=[];y.on('response',(a)=>{if(e=a.statusCode,200!=e&&206!=e)w?n({errMsg:`${i.api}:fail url not in domain list`}):n({errMsg:`${i.api}:ok`,statusCode:e});else{let b=parseInt(a.headers['content-length']);if(a.headers['content-type']){let b=a.headers['content-type'].split('/');b&&b[1]&&(o=`.${b[1]}`)}b>r&&(y.abort(),n({errMsg:`${i.api}:fail exceed max file size`}))}}).on('error',function(a){a&&'EPROTO'===a.code?n({errMsg:`${i.api}:fail 小程序要求的 TLS 版本必须大于等于 1.2`}):a&&'ETIMEDOUT'===a.code?n({errMsg:`${i.api}:fail timeout`}):n({errMsg:`${i.api}:fail ${a}`})}).on('data',(a)=>{d+=a.length,z.push(i),d>r&&(y.abort(),n({errMsg:`${i.api}:fail exceed max file size`}))}).on('end',()=>{let a=Buffer.concat(z),c=h.initTmpfileName(p,a,o),d=h.getFileRealPath(c),f=d.fileRealPath;b.writeFileSync(f,a),b.unlink(u,()=>{}),n({errMsg:`${i.api}:ok`,tempFilePath:c,statusCode:e})}).pipe(b.createWriteStream(u))}catch(a){n({errMsg:`${i.api}:fail ${a}`})}})},uploadFile:async function(c,i){let e=i.args;const j=g.getCurrentConfig(),k=j.setting.MaxUploadConcurrent,m=d.getState(),n=m.toolbar.network.list[m.toolbar.network.current];if('none'==n)return{errMsg:`${i.api}:fail network is down`};if(l>=k)return{errMsg:`${i.api}:fail exceed max upload connection count ${k}`};let o=e.filePath,p=h.getFileRealPath(o),q=p.fileRealPath;if(!b.existsSync(q))return{errMsg:`${i.api}:fail file not found`};const r=m.simulator.appConfig||{};return new Promise((c)=>{let d=!1;const h=(a)=>{d||(l--,d=!0,c(a))};try{l++;let c={url:e.url,headers:e.header||{},formData:e.formData||{},method:'post',timeout:r.networkTimeout&&r.networkTimeout.uploadFile||6e4};a()?c.agentOptions={secureProtocol:'TLSv1_2_method'}:c.tunnel=!1,c.formData[e.name]=b.createReadStream(q),c.headers.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;f(c,(a,b,c)=>{let d={};d=a?b&&b.statusCode?{errMsg:`${i.api}:ok`,statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{errMsg:`${i.api}:fail 小程序要求的 TLS 版本必须大于等于 1.2`}:'ETIMEDOUT'===a.code?{errMsg:`${i.api}:fail timeout`}:{errMsg:`${i.api}:fail ${a}`}:{errMsg:`${i.api}:ok`,statusCode:b.statusCode,data:c},h(d)})}catch(a){h({errMsg:`${i.api}:fail ${a}`})}})},createUploadTask:async function(c,j){let e=j.args,k=g.getCurrentConfig();const m=k.setting.MaxUploadConcurrent,p=d.getState(),q=p.toolbar.network.list[p.toolbar.network.current];if('none'==q)return{errMsg:`${j.api}:fail network is down`};if(l>=m)return{errMsg:`${j.api}:fail exceed max upload connection count ${m}`};let r=e.filePath,s=h.getFileRealPath(r),t=s.fileRealPath;if(!b.existsSync(t))return{errMsg:`${j.api}:fail file not found`};const u=p.simulator.appConfig||{};try{l++;let c={url:e.url,headers:e.header||{},formData:e.formData||{},method:'post',timeout:u.networkTimeout&&u.networkTimeout.uploadFile||6e4};c.headers.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`,a()&&(c.agentOptions={secureProtocol:'TLSv1_2_method'});let d=b.createReadStream(t);c.formData[e.name]=d;let h=o++,k=b.statSync(t),m=0;d.on('data',function(a){m+=a.length,i.triggerOnEvent({eventName:'onUploadTaskStateChange',data:{uploadTaskId:h,state:'progressUpdate',progress:Math.floor(100*(m/k.size)),totalBytesSent:m,totalBytesExpectedToSend:k.size}})});const p=(a)=>{n[h]&&(i.triggerOnEvent({eventName:'onUploadTaskStateChange',data:Object.assign({uploadTaskId:h},a)}),l--,delete n[h])};let q=f(c,(a,b,c)=>{let d={};d=a?b&&b.statusCode?{state:'success',statusCode:b.statusCode,data:c}:'EPROTO'===a.code?{state:'fail',errMsg:'\u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}:'ETIMEDOUT'===a.code?{statSync:'fail',errMsg:'timeout'}:{state:'fail',errMsg:`${a}`}:{state:'success',statusCode:b.statusCode,data:c},p(d)});return q.on('abort',()=>{setTimeout(()=>{p({state:'fail',errMsg:'abort'})},0)}),n[h]={id:h,request:q},{errMsg:`${j.api}:ok`,uploadTaskId:h}}catch(a){return l--,{errMsg:`${j.api}:fail ${a}'`}}},operateUploadTask:async function(a,b){let c=b.args,d=c.uploadTaskId,e=c.operationType,f=n[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},createDownloadTask:async function(l,n){let o=n.args;const r=d.getState(),s=r.toolbar.network.list[r.toolbar.network.current];let t=g.getCurrent();if('none'==s)return{errMsg:`${n.api}:fail network is down`};if(o.url&&!/^https?:\/\//.test(o.url.toLowerCase()))return{errMsg:`${n.api}:fail invalid url`};const u=g.getCurrentConfig(),v=u.setting.MaxDownloadConcurrent;if(m>=v)return{errMsg:`${n.api}:fail exceed max download connection count ${v}`};const w=1024*(1024*u.setting.DownloadFileSizeLimit);let x=o.header&&'object'==typeof o.header?o.header:{};x.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;try{m++;let d=0,s=[],u=200,v=c.extname(o.url.split('?')[0]),y=h.createTmpfileName(t,v),z=h.getFileRealPath(y),A=z.fileRealPath,B=r.simulator.appConfig||{},C=!1,D={method:'get',url:o.url,encoding:null,headers:x,timeout:B.networkTimeout&&B.networkTimeout.downloadFile||6e4,followRedirect:function(b){if(!a())return!0;let c=b.statusCode;if(300<=c&&400>c&&(302==c||301==c)){let a=g.getCurrentDomains().download,c=b.caseless.get('location'),d=c.split('?')[0]||'';for(let b,c=0;c<a.length;c++){if(b=a[c],b&&0===b.indexOf(d))return!0;if(/\/$/.test(b)||(b+='/'),0===d.indexOf(b))return!0}let e=[];a.forEach((a)=>{e.push([a])}),j.display({command:k.DISPLAY_INFO,type:k.DISPLAY_TYPES.DOMAIN_ERROR,data:{type:'download',url:`302: ${c}`,domains:e}}),C=!0}return!1}};a()?D.agentOptions={secureProtocol:'TLSv1_2_method'}:D.tunnel=!1;let E=q++;l({type:e.ASSDK_CALLBACK,res:{errMsg:`${n.api}:ok`,downloadTaskId:E},callbackID:n.callbackID});let F=f(D);p[E]={downloadTaskId:E,request:F};let G=w;const H=(a)=>{p[E]&&(delete p[E],m--,i.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:Object.assign({downloadTaskId:E},a)}))},I=(a)=>{i.triggerOnEvent({eventName:'onDownloadTaskStateChange',data:{downloadTaskId:E,state:'progressUpdate',progress:a}})};F.on('response',(a)=>{if(u=a.statusCode,200!=u&&206!=u)C?H({state:'fail',errMsg:'url not in domain list'}):H({state:'success',statusCode:u});else{let b=parseInt(a.headers['content-length']);if(b>w?(F.abort(),H({state:'fail',errMsg:'exceed max file size'})):G=b,a.headers['content-type']){let b=a.headers['content-type'].split('/');b&&b[1]&&(v=`.${b[1]}`)}}}).on('error',function(a){a&&'EPROTO'===a.code?H({state:fail,errMsg:'\u5C0F\u7A0B\u5E8F\u8981\u6C42\u7684 TLS \u7248\u672C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1.2'}):a&&'ETIMEDOUT'===a.code?H({state:'fail',errMsg:`timeout`}):H({state:'fail',errMsg:`${a}`})}).on('data',(a)=>{d+=a.length,s.push(a),d>w?(H({state:'fail',errMsg:'exceed max file size'}),F.abort()):I(d/G)}).on('abort',()=>{setTimeout(()=>{H({state:'fail',errMsg:'abort'})},0)}).on('end',()=>{let a=Buffer.concat(s),c=h.initTmpfileName(t,a,v),d=h.getFileRealPath(c),e=d.fileRealPath;b.writeFileSync(e,a),b.unlink(A,()=>{}),H({state:'success',tempFilePath:c,statusCode:u})}).pipe(b.createWriteStream(A))}catch(a){return{errMsg:`${n.api}:fail ${a}`}}},operateDownloadTask:async function(a,b){let c=b.args,d=c.downloadTaskId,e=c.operationType,f=p[d];return f?'abort'==e?(f.request&&f.request.abort(),{errMsg:`${b.api}:ok`}):{errMsg:`${b.api}:fail illegal operationType`}:{errMsg:`${b.api}:fail task not found`}},resetNetworkStatus:function(){for(var a in n)try{n[a].request.abort()}catch(a){}for(var a in p)try{p[a].request.abort()}catch(a){}l=0,m=0,n={},p={}}}}(require('lazyload'),require);