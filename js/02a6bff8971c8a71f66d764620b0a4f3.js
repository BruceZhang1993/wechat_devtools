'use strict';!function(require,directRequire){function a(){let a=g.getCurrent(),b='tourist'==a.appid,c=a.setting.urlCheck,d=!0;return b?d=!1:!c&&(d=!1),d}const b=require('fs'),c=require('path'),d=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),e=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),f=require('./233d77ecf0781f44985f684f70e316d0.js'),g=require('./3bfffbe88b3d923921f851c0697974fe.js'),h=require('./c6f15ef7a40988103528a2ff766b2425.js'),i=require('./a1dd553cc059d528bb0ef56afed53968.js');module.exports={downloadImage:async function(e,i){let j=i.args;const k=d.getState(),l=g.getCurrentConfig(),m=1024*(1024*l.setting.DownloadFileSizeLimit);return new Promise((d)=>{let e=!1;const k=(a)=>{e||(d(a),e=!0)};try{let d=0,e=200,l=h.createNewLocalId()+c.extname(j.url.split('?')[0]),n=h.getRealPath(l),o=j.header||{};o.Referer=`https://servicewechat.com/${g.getProjectAppID()}/devtools/page-frame.html`;let p={method:'get',url:j.url,encoding:null,headers:o,followRedirect:function(a){let b=!1;(project.urlCheck||project.isTourist)&&(b=!0);let c=a.statusCode;if(300<=c&&400>c&&(302==c||301==c)){let c=a.caseless.get('location'),d=g.getCurrentDomains().download;for(let a=0;a<d.length;a++)if(c&&0===c.indexOf(d[a])){b=!0;break}}return b}};a()?p.agentOptions={secureProtocol:'TLSv1_2_method'}:p.tunnel=!1;let q=f(p);q.on('response',(a)=>{if(e=a.statusCode,200!=e&&206!=e)k({errMsg:`${i.api}:ok`,statusCode:e});else{let b=parseInt(a.headers['content-length']);b>m&&(q.abort(),k({errMsg:`${i.api}:fail exceed max file size`}))}}).on('error',function(a){a&&'EPROTO'===a.code?k({errMsg:`${i.api}:fail 小程序要求的 TLS 版本必须大于等于 1.2`}):a&&'ETIMEDOUT'===a.code?k({errMsg:`${i.api}:fail timeout`}):k({errMsg:`${i.api}:fail ${a}`})}).on('data',(a)=>{d+=a.length,d>m&&(q.abort(),k({errMsg:`${i.api}:fail exceed max file size`}))}).on('end',()=>{k({errMsg:`${i.api}:ok`,tempFilePath:l,statusCode:e})}).pipe(b.createWriteStream(n))}catch(a){k({errMsg:`${i.api}:fail ${a}`})}})}}}(require('lazyload'),require);