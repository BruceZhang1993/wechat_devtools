'use strict';!function(require,directRequire){const a=require('react'),b=require('redux'),c=require('./f0466135fc8b3a662084784e5f4ac792.js'),d=require('./eadce02c750c875a10680bcfedadec88.js'),e=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),f=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),g=require('./fc137838572a83604db39acff8e909e0.js'),h=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),i=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),j=require('moment'),{connect:k}=require('react-redux');class l extends a.Component{constructor(a){j.locale(navigator.language),super(a),this.state={loading:!0,show:a.show,src:'',previewToolShown:!1},this.previewTimer=null,this._mounted=!1}componentDidMount(){this._mounted=!0,this.loadQRCode()}loadQRCode(){this.setState({loading:!0}),this.previewTimer=setTimeout(()=>{let a,b={test:!0};try{let c=this.props.project,d=c.compileType,f=c.condiction[d];a=f.list[f.current],d==e.search?a&&(b.searchQuery=a.customQuery||a.query,b.boxQI=a.customQuery?'':a.boxQI):d==e.weapp&&(b.page=a?a.pathName:this.props.appConfig.pages[0],b.query=a?a.query:'')}catch(a){}c(b).then((a)=>{if(this._mounted){let b=+new Date+1500000,c=j(b).calendar(),d=j(new Date).calendar();this.setState({generateTime:d,qrcode_time:c,src:`data:image/png;base64,${a.qrcode_img}`,loading:!1}),this.props.setPkgSize({preview:a.wxpkg_size,lastPreviewTime:+new Date})}}).catch((a)=>{this._mounted&&(this.props.showError(a),this.setState({show:!1}))})})}componentWillReceiveProps(a){a.show!=this.props.show&&this.setState({show:a.show}),a.timeStamp!==this.props.timeStamp&&this.loadQRCode()}componentWillUnmount(){this._mounted=!1,clearTimeout(this.previewTimer)}onHandleClick(a){a.stopPropagation()}onCopyClick(a,b){b.stopPropagation();let c=this.imgdom;'preview'===a&&(c=this.previewImgDom);let{left:d,top:e,height:f,width:g}=c.getBoundingClientRect();const h=()=>{let a=global.windowMap.get('MAIN'),b=a.window.document.body.offsetWidth;a.capturePage((a)=>{let h=document.createElement('canvas'),c=h.getContext('2d');h.height=f,h.width=g;let i=new Image;i.onload=()=>{let a=i.width/b;c.drawImage(i,d*a,e*a+5,g*a,f*a-5,0,0,g,f);let j=nw.Clipboard.get();j.set(h.toDataURL(),'png'),this.props.showSuccessTip('\u590D\u5236\u6210\u529F')},i.src=a},{format:'png',datatype:'datauri'})};this._blinkTimeout||(c.style.opacity=0.6,this._blinkTimeout=setTimeout(()=>{c.style.opacity=1,this._blinkTimeout=null,setTimeout(()=>h(),20)},200))}handleIconAskClick(a){a.stopPropagation();try{nw.Shell.openExternal('https://mp.weixin.qq.com/debug/wxadoc/dev/devtools/mydev.html')}catch(a){console.warn('open external failed.')}}showScanCode(a){a.stopPropagation(),this.setState({previewToolShown:!1})}showPreviewTool(a){a.stopPropagation(),this.setState({previewToolShown:!0})}render(){return a.createElement('div',{className:'preview-group',style:{position:'absolute',top:this.props.top,left:this.props.left,display:this.state.show?'':'none',width:'252px'}},a.createElement('div',{className:'ui-popover',style:{position:'relative',width:'252px'},onClick:this.onHandleClick.bind(this)},a.createElement('div',{className:'previewer'},a.createElement('div',{className:'previewer-header',onClick:this.showScanCode.bind(this),style:{cursor:'pointer'}},a.createElement('h4',null,'\u626B\u7801\u9884\u89C8')),a.createElement('div',{ref:(a)=>this.imgdom=a,style:{position:'relative'}},a.createElement('div',{className:'previewer-body',style:this.state.previewToolShown?{display:'none'}:{}},a.createElement('div',{className:'previewer-qrcode'},a.createElement('div',{className:'preview-qrcode-title',style:this.state.loading?{display:'none'}:{}},a.createElement('p',null,this.props.nickName,' \u4E8E ',this.state.generateTime||'\u672A\u77E5\u65F6\u95F4',' \u4E0A\u4F20')),a.createElement('img',{onClick:this.onCopyClick.bind(this,'qrcode'),src:this.state.src?this.state.src:'../static/image/qrcode.png',style:{minHeight:'200px'}}),a.createElement('div',{className:'preview-qrcode-tips'},a.createElement('p',{style:{display:this.state.qrcode_time?'':'none'}},a.createElement('span',null,this.state.qrcode_time),' \u65F6\u5931\u6548')),a.createElement('div',{className:'previewer-loading',style:this.state.loading?{}:{display:'none'}},a.createElement('i',{className:'ui-icon-spinner'}))))),a.createElement('div',{className:'preview-footer',style:this.state.previewToolShown?{display:'none'}:{}},a.createElement('button',{onClick:this.onCopyClick.bind(this,'qrcode'),className:'ui-button ui-button-default'},'\u590D\u5236')))),a.createElement('div',{className:'ui-popover',style:{position:'relative',width:'252px'},onClick:this.onHandleClick.bind(this)},a.createElement('div',{className:'previewer'},a.createElement('div',{className:'previewer-header',onClick:this.showPreviewTool.bind(this),style:{cursor:'pointer'}},a.createElement('h4',null,'\u5C0F\u7A0B\u5E8F\u5F00\u53D1\u52A9\u624B ',a.createElement('i',{className:'ui-icon-ask',style:{cursor:'pointer'},title:'\u70B9\u51FB\u67E5\u770B\u8BE6\u60C5',onClick:this.handleIconAskClick.bind(this)}))),a.createElement('div',{ref:(a)=>this.previewImgDom=a,style:this.state.previewToolShown?{}:{display:'none'}},a.createElement('div',{className:'previewer-body'},a.createElement('div',{className:'previewer-qrcode'},a.createElement('img',{onClick:this.onCopyClick.bind(this,'preview'),src:'../static/image/my-dev-apps.jpg',alt:''})))),a.createElement('div',{className:'preview-footer',style:this.state.previewToolShown?{}:{display:'none'}},a.createElement('button',{onClick:this.onCopyClick.bind(this,'preview'),className:'ui-button ui-button-default'},'\u590D\u5236')))))}}module.exports=k((a)=>{return{show:d.PREVIEWCODE===a.toolbar.clickKey,appConfig:a.simulator.appConfig||{},project:a.project.current,nickName:(a.user||{}).nickName||'\u672A\u77E5\u7528\u6237'}},(a)=>{return{showError:i.bindActionCreators(f.showError,a),toggleClickKey:i.bindActionCreators(g.toggleClickKey,a),setPkgSize:i.bindActionCreators(h.setPkgSize,a),showSuccessTip:i.bindActionCreators(f.showSuccessTip,a)}})(l)}(require('lazyload'),require);