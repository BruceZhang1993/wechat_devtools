'use strict';!function(require,directRequire){const a=require('react'),b=require('./116381854e0f6d40c39e7d1251aba7a8.js'),c=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),d=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),e=require('./ba23d8b47b1f4ea08b9fd49939b9443f.js'),f=require('./84705760a8692a44a583377e7f3f3b00.js'),g=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),h=require('./1dea83a77e99a7c94f6b6f01f5c175b0.js'),i=require('./common/locales/index.js'),{connect:j}=require('react-redux'),k=300;class l extends a.Component{constructor(a){super(a),this._onMessage=this.onMessage.bind(this),this.resetImageSizeControl()}componentDidMount(){b.register(this._onMessage),this.initWebview()}componentWillReceiveProps(a){(a.height!=this.props.height||a.width!=this.props.width)&&setTimeout(()=>{this.setWidgetOffset()}),a.ready==this.props.ready||a.ready||setTimeout(()=>{this.reload()})}componentWillUnmount(){this.webview&&this.webview.remove(),b.unRegister(this._onMessage)}onMessage(a){let{command:c,data:d}=a;'ON_CANVAS_TAP'==c&&b.toService({command:'APPSERVICE_ON_EVENT',data:{eventName:'onTap',data:d}})}resetImageSizeControl(){this.imageSizeControl={totalSize:0,timestamp:Date.now()}}setWidgetOffset(){let a=this.props,c={},e=a.height/a.deviceScale,f=a.width/a.deviceScale;a.compileType==d.search?c={width:f,height:e,style:'width:100%;height:100%'}:a.compileType==d.conversation&&(c={height:e,width:f,style:'width:100%;height:100%'}),this.webview&&this.webview.setAttribute('style',`position:absolute;height:${e}px;width:${f}px`),b.send({command:'SET_CANVAS',data:c})}setUserAgentOverride(){let a=this.props.ua.replace('{{webviewID}}',this.props.id);a+=` widget port/${global.messageCenterPort}`,this.webview.setUserAgentOverride(a)}initWebview(){if(this.webview)return void this.webview.remove();let a=this.props.id,b=this.webview=document.createElement('webview');b.className=`simulator-bd-webview_body webviewbody${a}`,b.setAttribute('partition','persist:simulator');let c=this.props.height/this.props.deviceScale,d=this.props.width/this.props.deviceScale;b.setAttribute('style',`position:absolute;height:${c}px;width:${d}px`),this.container.appendChild(b),this.setUserAgentOverride(),this.initEvent(),this.reload()}initEvent(){let a=this.webview;global.appConfig.isDev||global.appConfig.isGamma||a.contextMenus.onShow.addListener((a)=>{a.preventDefault()});let b=a.request;b.onErrorOccurred.addListener((a)=>{let{type:b}=a;'script'===b||'main_frame'===b||'net::ERR_ABORTED'===a.error||this.props.setWidget({errmsg:{group:i.config.WIDGET_NETWORK_ERROR,type:'error',msg:a.error}})},{urls:['<all_urls>']}),b.onBeforeSendHeaders.addListener((a)=>{let b=this.props.project;if(b){let d=a.requestHeaders||[],e=d.findIndex((a)=>{return'cookie'===a.name.toLowerCase()});d.splice(e,1);for(var c=0;c<d.length;++c)if('Referer'===d[c].name){let a=b.appid;b.platform&&b.ext_appid&&(a=b.ext_appid),d[c].value=`https://servicewechat.com/${a}/devtools/page-frame.html`}return{requestHeaders:a.requestHeaders}}},{urls:['<all_urls>']},['blocking','requestHeaders']),b.onCompleted.addListener((a)=>{let{type:b,statusCode:c}=a;if('script'!==b&&'main_frame'!==b&&400<=c){let b=a.url;this.props.setWidget({errmsg:{group:i.config.WIDGET_NETWORK_ERROR,type:'error',msg:`404: ${b.replace(this.baseURL,'')}`}})}},{urls:['<all_urls>']},['responseHeaders']),a.addEventListener('dialog',(a)=>{let b=a.messageType||'',c=a.messageText,d=a.dialog;'alert'===b?'DOCUMENT_READY'==c&&this.onDocumentReady():'confirm'===b?a.preventDefault():'prompt'===b}),a.request.onHeadersReceived.addListener((a)=>{let{type:b}=a;if('image'===b){let b=a.url;if(g.weappLocalIdRegular.test(b)||g.weappWidgetPageRegular.test(b))return{};if('wifi'!=this.props.networkType&&!this.imageSizeControl[b]){let c=0;a.responseHeaders.forEach((a)=>{'content-length'==a.name.toLowerCase()&&(c=parseInt(a.value))});let d=this.imageSizeControl.totalSize+c;if(d>1024*k)return this.props.setWidget({errmsg:{group:i.config.WIDGET_IMAGE_SIZE_ERROR,type:'error',msg:i.config.WIDGET_IMAGE_SIZE_ERROR_TIP.format(k)}}),{cancel:!0};this.imageSizeControl.totalSize+=c,this.imageSizeControl[b]=!0}}return{}},{urls:['<all_urls>']},['blocking','responseHeaders'])}reload(){h(this.props.project).then((a)=>{const b=c.getWidgetDirectory(this.props.compileType,a);this.baseURL=`http://${this.props.project.hash}.widget.open.weixin.qq.com/${b}`,this.webview.src=`${this.baseURL}/widgetPage.html`,this.resetImageSizeControl()})}onDocumentReady(){let a=this.props,c=a.condiction;if(a.compileType==d.conversation){let d=c.pathName||'',e=d.split('?'),f={};try{e=e[1].split('&'),e.forEach((a)=>{let b=a.split('=');f[b[0]]=b[1]})}catch(a){f={}}b.toService({command:'APPSERVICE_ON_EVENT',data:{eventName:'onCanvasInsert',data:{title:c.title||'',cacheKey:c.cacheKey||'',path:d.split('?')[0],query:f,width:a.width,height:a.height}}}),this.setWidgetOffset(),this.props.setWidget({ready:!0})}else if(a.compileType==d.search){let d=c.service&&c.service.box_type,e=c.query||'',h=c.boxQI||'';f.getInitData({type:d,query:e,boxQI:h}).then((f)=>{let j='',k='',l=g.default_search_widget_radio,m=a.height,n=a.width;try{let b=f.resultlist[0].providerlist[0].providerinfo;j=b.wxaData,k=b.widgetData,m=b.height/b.width*a.width}catch(b){j='',k='',n=a.width,m=a.height}try{f.debug_info&&this.props.setWidget({errmsg:{group:i.config.WIDGET_SERVER_DEBUG,type:'info',msg:`网络状态码: ${f.debug_info.status_code||''}
返回: ${f.debug_info.resp_data||''}
耗时: ${f.debug_info.cost_time_ms||''}`}})}catch(a){}this.props.setWidget({ready:!0,height:m,wxaData:j}),this.setWidgetOffset(),b.toService({command:'APPSERVICE_ON_EVENT',data:{eventName:'onCanvasInsert',data:{query:{query:e,type:d,wxaData:j,widgetData:c.widgetData||k,wxParamData:h},width:n,height:Math.ceil(m)}}})}).catch((a)=>{this.props.setWidget({ready:!0,errmsg:{group:i.config.WIDGET_NETWORK_ERROR,type:'error',msg:i.config.WIDGET_GET_SEARCH_RESULT_ERROR.format(a)}})})}}render(){let b=this.props,c={height:b.height,width:b.width,position:'absolute'};return a.createElement('div',{className:'webview',ref:(a)=>this.container=a,style:c})}}module.exports=j((a)=>{var b=Math.floor;let e=a.toolbar.deviceInfo,f=a.project.current,g=f.compileType,h=c.getWidgetOffset(g,e),{width:i,height:j}=h;g==d.search&&a.simulator.widget&&a.simulator.widget.height&&(j=a.simulator.widget.height);let k=f.condiction[g]||{},l=k.list[k.current]||{},m=a.toolbar.network.list[a.toolbar.network.current]||'wifi';return{deviceScale:a.toolbar.deviceScale,ua:e.ua||'',id:2e4,project:a.project.current,compileType:g,width:b(i),height:b(j),ready:a.simulator.widget&&a.simulator.widget.ready,networkType:m,condiction:l}},(a)=>{return{setWidget:c.bindActionCreators(e.setWidget,a)}})(l)}(require('lazyload'),require);