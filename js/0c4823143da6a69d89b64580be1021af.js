'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('react'),b=require('prop-types'),c=require('./41c99b908d0cb118c2a6fcf3c306663c.js'),d=require('./3b5f8e2469c474c8d433c1c6926d8999.js'),e=require('./a15851ca252a104aad8b3fd3fc114574.js'),f=require('./0db6515f85d6f6210c2d50722041eb1f.js'),g=require('./d00040b9bed6196b3701ea7c8a4b4db3.js'),h=require('./72653d4b93cdd7443296229431a7aa9a.js'),i=require('./709f7f8328edb932b1169de8b7e694dd.js'),j=require('./3e4c71c2a2cc438e1b3afc3fb10bd4b6.js'),k=require('./a1dd553cc059d528bb0ef56afed53968.js'),l=require('./919ad605b043ca39c480b04f2062eb9a.js'),m=require('./6238a86bb7a55c11aa0f9eb335d0f34c.js'),n=require('./3bfffbe88b3d923921f851c0697974fe.js'),o=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),p=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),q=require('url'),r=require('./common/locales/index.js'),s=require('./a78e6d6a87de1708226375ca4c320d76.js'),t=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),u=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js');let v={};class w extends a.Component{constructor(a){super(a),this._consolemessage=this.consolemessage.bind(this),this._onWebviewMessage=this.onWebviewMessage.bind(this),this.state={zIndex:'standby'==a.type?-1:0},this.consoleMsgQueue={}}componentDidMount(){let a=this.props,b=this.container,c=this.webviewID=a.info.id,d=this.webview=s.get('simulator',{width:a.width,height:a.height,dpr:a.dpr});this.setWebviewHeight(a.height),'tip'==a.type?d.src=`html/weappabout.html?${c}`:(this.initEvent(),this.initDebuggeeEvent(),d.src=`http://127.0.0.1:${global.proxyPort}/aboutblank?${c}`),d.attach(b),e.register(c,this._onWebviewMessage)}componentWillReceiveProps(a){if(a.jssdkCallbackInfo!=this.props.jssdkCallbackInfo){let{callbackID:b,res:c,webviewID:d}=a.jssdkCallbackInfo;d==a.info.id&&e.invokeCallback(d,b,c)}a.captureScreen!=this.props.captureScreen&&a.captureScreen.webviewID==this.webviewID&&setTimeout(()=>{this.captureScreen()}),a.info.pathName!=this.props.info.pathName&&a.info.pathName&&setTimeout(()=>{this.loadPage()}),a.type!=this.props.type&&'standby'!=a.type&&this.setState({zIndex:0}),this.props.info.ready&&a.show!=this.props.show&&(clearTimeout(this.hideTimer),a.show?this.setState({zIndex:2}):this.hideTimer=setTimeout(()=>{this.setState({zIndex:1})},200)),a.shareInfoShow!=this.props.shareInfoShow&&a.shareInfoShow&&a.show&&this.webview.executeScript({code:`alert('GET_WEBVIEW_SCROLL_Y' + window.scrollY);window.scrollTo(0,0);`},()=>{this.webview.captureVisibleRegion((a)=>{this.props.simulatorActions.setShareDataURI(this.webviewID,a),this.webview.executeScript({code:`window.scrollTo(0,${this.webviewScrollY})`},()=>{this.webviewScrollY=void 0})})})}componentWillUnmount(){this.webview&&this.webview.detach(),this.props.simulatorActions.setDebuggee(void 0,this.webviewID,!1),e.unRegister(this.webviewID,this._onWebviewMessage)}captureScreen(){this.webview.captureVisibleRegion({format:'png'},(a)=>{let b=Buffer.from(a.replace('data:image/png;base64,',''),'base64'),c=u.copyFileDataToTemp(this.props.project,b,'.png'),{webviewID:d,callbackID:e}=this.props.captureScreen;this.props.simulatorActions.assdkCallback({callbackID:e,res:{errMsg:'captureScreen:ok',tempFilePath:c}})})}setWebviewHeight(a){let b=this.props.width/this.props.deviceScale;a/=this.props.deviceScale,this.webview.setAttribute('style',`position:absolute;height:${a}px;width:${b}px;`);try{this.webview.setOffset({height:this.props.height,width:this.props.width,dpr:this.props.dpr})}catch(a){}}reload(){this.documentReady=!1;let a=this.webview;this.setUserAgentOverride(),a.src=`http://127.0.0.1:${global.proxyPort}/__pageframe__/pageframe.html`}setUserAgentOverride(){let a=this.props.ua.replace('{{webviewID}}',this.webviewID);a+=`port/${global.messageCenterPort}`,this.webview.setUserAgentOverride(a)}async animateWebviewTransition(a){return new Promise((b)=>{if(!this.container)return;let{top:c,left:d,height:e,width:f}=this.container.getBoundingClientRect();if(e/=this.props.deviceScale,f/=this.props.deviceScale,c=this.props.top,d=0,'enter'===a){const a=this.container.style.cssText,g=`position:fixed; width:${f}px; height:${e}px; top:${c}px; left:${d}px;`;this.container.style.cssText='z-index: 2;'+g,this.container.style.transform=`translate(${f}px, 0)`;const h=()=>{this.container.removeEventListener('transitionend',h),this.container.style.cssText=a,this.setState({zIndex:this.props.show?1:0},b)};this.container.addEventListener('transitionend',h);let i=this.context.currentNWWindow||global.Win;i.window.requestAnimationFrame(()=>{this.container.style.transition='all linear 0.2s',this.container.style.transform='translate(0,0)'}),this.container.offsetHeight}else if('exit'===a){const a=this.container.style.cssText,g=`position:fixed; width:${f}px; height:${e}px; top:${c}px; left:${d}px;`;this.container.style.cssText='z-index: 2;'+g,this.container.style.transform=`translate(0, 0)`;const h=()=>{this.container.removeEventListener('transitionend',h),this.container.style.cssText=a,this.setState({zIndex:this.props.show?1:0},b)};this.container.addEventListener('transitionend',h);let i=this.context.currentNWWindow||global.Win;i.window.requestAnimationFrame(()=>{this.container.style.transition='all linear 0.2s',this.container.style.transform=`translate(${f}px,0)`}),this.container.offsetHeight}})}getPageCode(a){return new Promise((b)=>{let c={code:'',name:'$gwx'},d=[],e=2,f=()=>{e--,0>=e&&b({wxml:c,wxss:d.join('\n')})};j(this.props.project,{page:a}).then((a)=>{a&&a.code&&(c={code:a.code.replace(/\\/g,'\\\\').replace(/`/g,'\\`'),name:a.name}),f()}).catch((a)=>{h.error(`transwxmltojs error ${a}`),m.parseWxmlErr(this.props.project,a.msgForConsole).then((a)=>{l({message:a})}),f()}),i(this.props.project,{page:a}).then((a)=>{a.comm&&d.push(`${a.comm}`),a.page&&d.push(`${a.page}()`),f()}).catch((a)=>{h.error(`transwxsstojs error ${a}`),m.parseWxssErr(this.props.project,a).then((a)=>{l({message:a})})})})}async loadPage(){let a=this.webview;if(!this.webview||!this.props.info||!this.props.info.pathName||!this.documentReady)return;let b=this.props.info.pathName,c=q.parse(a.src);c.pathname=`__pageframe__/${b}`;let d=q.format(c),e=this.props.appConfig,f=e.global&&e.global.window||{};if(e&&e.page&&e.page[`${b}.html`]){let a=e.page[`${b}.html`];f=_extends({},f,a.window)}this.setWebviewHeight(this.props.height);let{wxml:g,wxss:h}=await this.getPageCode(b),i={window:f},j=`
      history.pushState('','', '${d}')
      var generateFunc = ${g.name}('./${b}.wxml')
      if (generateFunc) {
        document.dispatchEvent(new CustomEvent("generateFuncReady", {
          detail: {
            generateFunc: generateFunc
          }
       }))
      } else {
        document.body.innerText = '未找到 ${b}.wxml 文件'
        console.error('未找到 ${b}.wxml 文件')
      }
    `,k=`
      var script = document.createElement('script')
      script.text = \`
        ${g.code};
        __wxConfig=${JSON.stringify(i)};
        ${i.window.enablePullDownRefresh?'window.enablePullDownRefresh();':''};
        ${j};
        ${h};
      \`
      document.head.appendChild(script)
      `;i.window.disableScroll&&(k+=`
      var style = document.createElement('style')
      style.innerText = 'body{overflow-y:hidden;}'
      document.head.appendChild(style)
      `),a.executeScript({code:k},()=>{Date.now();this.props.simulatorActions.setWebviewReady(this.webviewID,!0)})}consolemessage(a){let b=a.message;this.consoleMsgQueue[b]||(this.consoleMsgQueue[b]=!0,l(a))}onWebviewMessage(a){let b={};try{b=JSON.parse(a)}catch(b){return void h.error(`onWebviewMessage parse ${a} error ${b}`)}if('WEBVIEW_PUBLISH'==b.command)e.publish(a);else if('WEBVIEW_INVOKE'==b.command){let a=b.data.api;'initReady'==a&&this.initReady(),this.props.jssdkActions.exec(b.data,this.webviewID)}else'PULLDOWN_REFRESH'==b.command&&k.triggerOnEvent({eventName:'onPullDownRefresh',data:{},webviewID:this.webviewID})}initReady(){setTimeout(()=>{b()},20);let a=-1==this.props.info.tabbarIndex;var b=()=>{a?(this.animateWebviewTransition('enter'),this.props.simulatorActions.setAppRoute({status:'done'})):(this.setState({zIndex:this.props.show?2:1}),this.props.simulatorActions.setAppRoute({status:'done'}))}}initDebuggeeEvent(){this.webview.onDebuggeeEvent=(a,b,c={})=>{('Overlay.inspectNodeRequested'===b&&this.props.simulatorActions.setWxmlInspect(!1),'DOM.inlineStyleInvalidated'!==b&&'DOM.characterDataModified'!==b)&&('Overlay.nodeHighlightRequested'!==b||'Overlay.nodeHighlightRequested'!==v.method||c.nodeId!==v.nodeId)&&(v='Overlay.nodeHighlightRequested'===b?{method:b,nodeId:c.nodeId}:{},g.send({command:'ON_EVENT',data:{debuggee:a,method:b,params:c}}))},this.webview.onDebuggeeDetach=(a)=>{this.props.simulatorActions.setDebuggee(a,this.webviewID,!1)},this.webview.onDebuggeeAttach=(a)=>{this.props.simulatorActions.setDebuggee(a,this.webviewID,!0),this.reload()}}initEvent(){let a=this.webview;a.on('consolemessage',this._consolemessage),a.on('dialog',(a)=>{let b=a.messageType||'',c=a.messageText,d=a.dialog;'alert'===b?'DOCUMENT_READY'==c?(this.documentReady=!0,this.loadPage()):0==c.indexOf('GET_WEBVIEW_SCROLL_Y')?this.webviewScrollY=c.replace('GET_WEBVIEW_SCROLL_Y',''):0==c.indexOf('\u8FDB\u5165\u5BA2\u670D\u4F1A\u8BDD')&&this.props.simulatorActions.setConfirm({show:!0,content:c,showCancel:!1,confirmText:'\u8FD4\u56DE'}):'confirm'===b?a.preventDefault():'prompt'===b}),a.on('mouseleave',()=>{a.setEmulationTouch(!1)}),a.on('mouseenter',()=>{this.props.wxmlInspected||a.setEmulationTouch(!0)}),this.initRequestListener(a)}initRequestListener(a){a.request;this.webview.onRequestErrorOccurred=(a)=>{let{type:b}=a;'script'===b||'main_frame'===b||'net::ERR_ABORTED'===a.error||'image'==a.type&&`http://127.0.0.1:${global.proxyPort}/__pageframe__/${this.props.info.pathName}`==a.url||p.display({command:o.DISPLAY_ERROR,type:o.DISPLAY_TYPES.WEBVIEW_NETWORK_ERROR,data:a})},this.webview.onBeforeRequest=(a)=>{let b=a.url;if(0==b.indexOf(`http://127.0.0.1:${global.proxyPort}/`)){let a=q.parse(b),c=a.pathname.replace(/^\//,'');if('aboutblank'!=c&&'favicon.ico'!=c&&!/^__pageframe__\//.test(c))return{redirectUrl:`http://127.0.0.1:${global.proxyPort}/__pageframe__/${c}`}}},this.webview.onRequestBeforeSendHeaders=(a)=>{let b=a.url;if(0!=b.indexOf(`http://127.0.0.1:${global.proxyPort}/`)&&'none'==this.props.networkType)return p.display({command:o.DISPLAY_ERROR,data:{title:r.config.NO_NETWORK_TIPS_TITLE,msg:r.config.NO_NETWORK_TIPS_CONTENT.format(b)}}),{cancel:!0};if(0==b.indexOf(`http://127.0.0.1:${global.proxyPort}/__pageframe__`)){let a=q.parse(b),c=a.pathname.replace(/^\/__pageframe__\//,''),d=t.checkIsInSubPackage(this.props.appConfig,c),e=t.checkIsInSubPackage(this.props.appConfig,this.props.info.pathName);if(d&&d!=e)return p.display({command:o.DISPLAY_ERROR,data:{title:r.config.RESOURCE_RELATIVE_TIPS_TITLE,msg:r.config.RESOURCE_RELATIVE_TIPS_CONTENT.format(c)}}),{cancel:!0}}let c=a.requestHeaders||[],d=c.findIndex((a)=>{return'cookie'===a.name.toLowerCase()});c.splice(d,1);for(var e=0;e<c.length;++e)if('Referer'===c[e].name){let a=n.getProjectAppID();c[e].value=`https://servicewechat.com/${a}/devtools/page-frame.html`}return{requestHeaders:a.requestHeaders}},this.webview.onRequestCompleted=(a)=>{let{type:b,statusCode:c}=a;if('script'!==b&&'main_frame'!==b&&400<=c){if('image'==a.type&&`http://127.0.0.1:${global.proxyPort}/__pageframe__/${this.props.info.pathName}`==a.url)return;p.display({command:o.DISPLAY_ERROR,type:o.DISPLAY_TYPES.WEBVIEW_NETWORK_ERROR,data:a})}}}render(){let b=this.props,d={position:'absolute',width:b.width,height:b.height,top:b.top,zIndex:this.state.zIndex};return a.createElement('div',{className:'webview',ref:(a)=>this.container=a,style:d},a.createElement(c,{info:b.info}))}}w.contextTypes={currentNWWindow:b.object},module.exports=w}(require('lazyload'),require);